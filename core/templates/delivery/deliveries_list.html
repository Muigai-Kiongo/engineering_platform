{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl mx-auto mt-8">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold text-yellow-700">My Deliveries</h1>

    <form method="get" class="flex gap-2 items-center">
      <input name="q" value="{{ q|default:'' }}" placeholder="Order id, material or engineer" class="px-3 py-2 rounded border" />
      <select name="status" class="px-3 py-2 rounded border">
        <option value="">All statuses</option>
        <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
        <option value="dispatched" {% if status == 'dispatched' %}selected{% endif %}>Dispatched</option>
        <option value="in_transit" {% if status == 'in_transit' %}selected{% endif %}>In Transit</option>
        <option value="delivered" {% if status == 'delivered' %}selected{% endif %}>Delivered</option>
        <option value="failed" {% if status == 'failed' %}selected{% endif %}>Failed</option>
        <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
      </select>
      <button class="px-3 py-2 bg-orange-400 text-white rounded">Filter</button>
    </form>
  </div>

  {% if deliveries %}
    <div class="bg-white rounded shadow border">
      <table class="min-w-full divide-y divide-yellow-50">
        <thead class="bg-yellow-50">
          <tr>
            <th class="p-2 text-left text-xs font-semibold text-yellow-900">#</th>
            <th class="p-2 text-left text-xs font-semibold text-yellow-900">Material</th>
            <th class="p-2 text-left text-xs font-semibold text-yellow-900">Address</th>
            <th class="p-2 text-left text-xs font-semibold text-yellow-900">Status</th>
            <th class="p-2 text-left text-xs font-semibold text-yellow-900">When</th>
            <th class="p-2 text-right text-xs font-semibold text-yellow-900">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for d in deliveries %}
            <tr class="border-t">
              <td class="p-2 text-sm">#{{ d.order.id }}</td>
              <td class="p-2 text-sm">{% if d.order.material %}{{ d.order.material.name }}{% else %}Material{% endif %}</td>
              <td class="p-2 text-sm">{{ d.delivery_location|default:'—' }}</td>
              <td class="p-2 text-sm">
                {# derive human-friendly status from timestamps in template for clarity #}
                {% if d.delivered_at %}
                  Delivered
                {% elif d.dispatched_at %}
                  In Transit
                {% else %}
                  Pending
                {% endif %}
              </td>
              <td class="p-2 text-sm">
                {% if d.dispatched_at %}
                  {{ d.dispatched_at|date:"M d, Y H:i" }}
                {% elif d.delivered_at %}
                  {{ d.delivered_at|date:"M d, Y H:i" }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="p-2 text-right"><a href="{% url 'delivery_detail' d.pk %}" class="text-xs text-blue-700 hover:underline">Open</a></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-3">
      {% if deliveries.has_other_pages %}
        <div class="flex gap-2">
          {% if deliveries.has_previous %}
            <a href="?page={{ deliveries.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}" class="px-3 py-1 bg-yellow-100 rounded">Previous</a>
          {% endif %}
          {% if deliveries.has_next %}
            <a href="?page={{ deliveries.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}" class="px-3 py-1 bg-yellow-100 rounded">Next</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="text-gray-500 py-8 text-center">No deliveries found.</div>
  {% endif %}
</div>
{% endblock %}